<div class="contenedor-formulario-propiedad">
  <!-- Contenedor de imagen izquierdo -->
  <div class="contenedor-imagen">
    <div class="overlay-imagen">
      <h2 class="frase-animada">
        {{ esEdicion ? "Actualiza la información de tu propiedad" : "Registra tu propiedad y comienza a generar ingresos" }}
      </h2>
    </div>
    <img src="/assets/fondo_fr.png" alt="Registro de Propiedad" class="imagen-fondo" />
  </div>

  <!-- Contenedor de formulario derecho -->
  <div class="contenedor-formulario">
    <div class="tarjeta-registro">
      <!-- Encabezado -->
      <div class="encabezado-registro">
        <i class="bi bi-house-door-fill icono-titulo"></i>
        <h2 class="titulo">{{ esEdicion ? "Editar Propiedad" : "Registrar Nueva Propiedad" }}</h2>
        <p class="subtitulo">Completa la información de tu propiedad</p>
      </div>

      <!-- Indicador de pasos -->
      <div class="indicador-pasos" *ngIf="mostrarPasos">
        <div class="paso" [class.activo]="pasoActual >= 1" [class.completado]="pasoActual > 1">
          <div class="circulo-paso">
            <i class="bi" [class.bi-check-lg]="pasoActual > 1" [class.bi-house]="pasoActual <= 1"></i>
          </div>
          <span class="texto-paso">Información</span>
        </div>
        <div class="linea-paso" [class.activa]="pasoActual > 1"></div>
        <div class="paso" [class.activo]="pasoActual >= 2">
          <div class="circulo-paso"><i class="bi bi-file-earmark-arrow-up"></i></div>
          <span class="texto-paso">Documento</span>
        </div>
      </div>

      <!-- Formulario - Ambos pasos están dentro del mismo form -->
      <form [formGroup]="formularioPropiedad" (ngSubmit)="guardarPropiedad()" class="formulario-paso">

        <!-- PASO 1: Información de la propiedad -->
        <div *ngIf="esEdicion || pasoActual === 1">
          <!-- Nombre de la propiedad -->
          <div class="fila-campos">
            <div class="grupo-campo">
              <label for="nombre" class="etiqueta">
                <i class="bi bi-building"></i> Nombre de la Propiedad
              </label>
              <input
                id="nombre"
                formControlName="nombre"
                type="text"
                class="campo-entrada"
                [class.invalido]="esCampoInvalido('nombre')"
                placeholder="Ej. Casa en el centro"
              />
              <div class="mensaje-error" *ngIf="esCampoInvalido('nombre')">
                <i class="bi bi-exclamation-circle-fill"></i>
                <span>{{ obtenerMensajeError("nombre") }}</span>
              </div>
            </div>

            <!-- Estado (solo en edición) -->
            <div class="grupo-campo" *ngIf="esEdicion">
              <label for="estado" class="etiqueta">
                <i class="bi bi-toggle-on"></i> Estado Visible
              </label>
              <select id="estado" formControlName="estado" class="campo-entrada" [class.invalido]="esCampoInvalido('estado')">
                <option value="">Seleccione un estado</option>
                <option value="Disponible">Disponible</option>
                <option value="Ocupada">Ocupada</option>
              </select>
              <div class="mensaje-error" *ngIf="esCampoInvalido('estado')">
                <i class="bi bi-exclamation-circle-fill"></i>
                <span>{{ obtenerMensajeError("estado") }}</span>
              </div>
            </div>
          </div>

          <!-- Ubicación -->
          <div class="seccion-ubicacion">
            <h3 class="titulo-seccion"><i class="bi bi-map"></i> Ubicación</h3>

            <div class="fila-campos">
              <div class="grupo-campo" *ngFor="let campo of camposConfig.ubicacion.slice(0, 3)">
                <label [for]="campo.id" class="etiqueta">
                  <i class="bi" [ngClass]="campo.icon"></i> {{ campo.label }}
                </label>
                <input
                  [id]="campo.id"
                  [formControlName]="campo.id"
                  type="text"
                  class="campo-entrada"
                  [class.invalido]="esCampoInvalido(campo.id)"
                  [placeholder]="campo.placeholder"
                />
                <div class="mensaje-error" *ngIf="esCampoInvalido(campo.id)">
                  <i class="bi bi-exclamation-circle-fill"></i>
                  <span>{{ campo.label }} es requerido</span>
                </div>
              </div>
            </div>

            <div class="fila-campos">
              <div class="grupo-campo" *ngFor="let campo of camposConfig.ubicacion.slice(3)">
                <label [for]="campo.id" class="etiqueta">
                  <i class="bi" [ngClass]="campo.icon"></i> {{ campo.label }}
                </label>
                <input
                  [id]="campo.id"
                  [formControlName]="campo.id"
                  type="text"
                  class="campo-entrada"
                  [class.invalido]="esCampoInvalido(campo.id)"
                  [placeholder]="campo.placeholder"
                />
                <div class="mensaje-error" *ngIf="esCampoInvalido(campo.id)">
                  <i class="bi bi-exclamation-circle-fill"></i>
                  <span>{{ campo.label }} es requerido</span>
                </div>
              </div>
            </div>

            <!-- Mapa de selección -->
            <div class="grupo-campo-mapa">
              <label class="etiqueta">
                <i class="bi bi-map-fill"></i> Ubicación en el mapa
              </label>
              <app-mapa-seleccion
                [initialCoords]="coordsIniciales"
                [searchText]="direccionBusqueda"
                (coordenadasChange)="onCoordsChange($event)"
              ></app-mapa-seleccion>
            </div>
          </div>

          <!-- Botones del paso 1 -->
          <div class="grupo-botones" *ngIf="esEdicion">
            <button type="button" (click)="cancelar()" class="boton boton-secundario">
              <i class="bi bi-x-lg"></i> Cancelar
            </button>
            <button type="submit" [disabled]="!datosValidos || procesando" class="boton boton-primario">
              Actualizar Propiedad <i class="bi bi-check-lg"></i>
            </button>
          </div>

          <button
            type="button"
            *ngIf="!esEdicion"
            (click)="siguientePaso()"
            [disabled]="!datosValidos"
            class="boton boton-primario boton-siguiente"
          >
            Siguiente <i class="bi bi-arrow-right"></i>
          </button>
        </div>

        <!-- PASO 2: Subir documento (FIX APLICADO AQUÍ) -->
        <div *ngIf="!esEdicion && pasoActual === 2">

          <!-- FIX: El select ahora está dentro del form y vinculado correctamente -->
          <div class="grupo-campo">
            <label for="tipoDocumentoId" class="etiqueta">
              <i class="bi bi-file-earmark"></i>
              Elige el tipo de documento de la propiedad a validar
            </label>
            <select
              id="tipoDocumentoId"
              formControlName="tipoDocumentoId"
              class="campo-entrada"
              [class.invalido]="esCampoInvalido('tipoDocumentoId')"
            >
              <option value="">Seleccione un tipo de documento</option>
              <option *ngFor="let tipo of tiposDocumento" [value]="tipo.id">
                {{ tipo.nombre }}
              </option>
            </select>
            <div class="mensaje-error" *ngIf="esCampoInvalido('tipoDocumentoId')">
              <i class="bi bi-exclamation-circle-fill"></i>
              <span>Debes seleccionar un tipo de documento</span>
            </div>
          </div>

          <!-- Nota informativa -->
          <div class="nota-tipos-archivo">
            <div class="nota-contenido">
              <i class="bi bi-info-circle-fill"></i>
              <div class="nota-texto">
                <p class="nota-principal">Elige el documento de tu propiedad</p>
                <div class="tipos-permitidos">
                  <span class="tipo-archivo"><i class="bi bi-file-earmark-text"></i> Recibo de Agua</span>
                  <span class="tipo-archivo"><i class="bi bi-file-earmark-text"></i> Recibo de Luz</span>
                </div>
                <p class="nota-secundaria">Documento oficial que valide la propiedad</p>
              </div>
            </div>
          </div>

          <!-- Subir archivo -->
          <div class="grupo-campo">
            <label class="etiqueta">
              <i class="bi bi-file-earmark-arrow-up"></i>
              Documento de la propiedad
            </label>

            <div class="nota-tipos-archivo">
              <div class="nota-contenido">
                <i class="bi bi-info-circle-fill"></i>
                <div class="nota-texto">
                  <p class="nota-principal">Solo se permiten los siguientes formatos:</p>
                  <div class="tipos-permitidos">
                    <span class="tipo-archivo"><i class="bi bi-file-earmark-image"></i> PNG</span>
                    <span class="tipo-archivo"><i class="bi bi-file-earmark-image"></i> JPG/JPEG</span>
                    <span class="tipo-archivo"><i class="bi bi-file-earmark-pdf"></i> PDF</span>
                  </div>
                  <p class="nota-secundaria">Documento oficial que acredite la propiedad</p>
                </div>
              </div>
            </div>

            <div class="zona-archivo" [class.con-archivo]="archivoSeleccionado">
              <input
                id="archivo"
                type="file"
                (change)="onArchivoSeleccionado($event)"
                accept="image/*,.pdf"
                class="input-archivo"
              />
              <label for="archivo" class="etiqueta-archivo">
                <i class="bi bi-cloud-upload icono-archivo"></i>
                <span class="texto-principal">
                  {{ archivoSeleccionado ? archivoSeleccionado.name : "Haz clic para seleccionar" }}
                </span>
                <span class="texto-secundario">PDF o imagen (máx. 5MB)</span>
              </label>
            </div>
          </div>

          <!-- Previsualización -->
          <div *ngIf="urlPrevisualizacion" class="seccion-previsualizacion">
            <h4 class="titulo-previsualizacion">
              <i class="bi bi-eye"></i> Previsualización
            </h4>
            <div class="contenedor-previsualizacion">
              <img
                *ngIf="esImagen"
                [src]="urlPrevisualizacion"
                alt="Previsualización del documento"
                class="imagen-previsualizacion"
              />
              <div *ngIf="esPdf" class="previsualizacion-pdf">
                <i class="bi bi-file-pdf icono-pdf"></i>
                <p class="nombre-archivo">{{ archivoSeleccionado?.name }}</p>
                <small class="info-archivo">Archivo PDF seleccionado</small>
              </div>
            </div>
          </div>

          <!-- Botones del paso 2 -->
          <div class="grupo-botones">
            <button type="button" (click)="anteriorPaso()" class="boton boton-secundario" [disabled]="procesando">
              <i class="bi bi-arrow-left"></i> Anterior
            </button>
            <button type="submit" [disabled]="!archivoValido || procesando" class="boton boton-primario">
              Registrar Propiedad <i class="bi bi-check-lg"></i>
            </button>
          </div>
        </div>

      </form>

      <!-- Procesamiento de documento -->
      <app-procesamiento-documento
        [visible]="procesando"
        mensaje="Procesando propiedad..."
      ></app-procesamiento-documento>
    </div>
  </div>
</div>
